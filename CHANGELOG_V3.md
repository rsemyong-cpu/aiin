# Forlove Keyboard V3 工程总结 (Changelog V3)

此文档总结了 V3 阶段针对 **配置同步、槽位动态展示、候选交互重构及网络安全** 的修复与增强。

## 1. 核心修复：配置同步与槽位系统

### 1.1 App Group 存储增强 (`AppGroupStore.swift`)
*   **诊断与修复**：识别并解决了 App Group 配置不生效导致的配置无法同步问题。
*   **降级机制**：添加了备用存储逻辑，当 App Group 初始化失败时自动降级到标准 `UserDefaults`（确保开发调试不中断）。
*   **数据持久化**：强制使用 `synchronize()` 确保主 App 的修改立即可被键盘扩展读取。
*   **调试增强**：新增详细日志记录和 `debugPrintStatus()` 方法，可在控制台实时查看存储状态。

### 1.2 动态顶部操作栏 (`TopActionBarView.swift`)
*   **逻辑重构**：从硬编码的“帮你回/开场/润色”改为**动态读取用户配置的 3 个激活槽位**。
*   **组件更新**：移除 `PillButton`，改用 `SlotPillButton` 以支持不同主分类（如法律专家、生活百科、夸捧模式等）的标题显示。
*   **状态修复**：修复了点击第三个按钮自动跳回第一个按钮的逻辑错误（移除了向后兼容的 Intent 重置逻辑）。

## 2. 交互系统重构：三层候选逻辑

针对用户“第一条默认填入，后两条选填/替换”的需求执行了深度定制：

### 2.1 自动填入系统 (`KeyboardViewController.swift`)
*   **逻辑实现**：API 返回候选后，首条候选自动通过 `insertText` 填入当前 App 输入框。
*   **UI 状态提示**：首条卡片显示“✓ 已填入输入区”状态，使用金色边框高亮。

### 2.2 备选与替换系统 (`CandidateListView.swift`)
*   **双层展示**：
    *   **第一层 (Primary)**：展示已填入内容的快照，支持“重新生成”和“复制”。
    *   **第二层 (Secondary)**：逻辑复用层。显示“备选方案”，初始为第 2 条。
*   **交互按钮**：
    *   **换一条**：在第 2 条和第 3 条候选之间循环切换。
    *   **替换**：点击后先清空输入框内容，再填入当前显示的备选文本。

## 3. 网络与性能优化

*   **请求限流**：在 `KeyboardViewController` 中实施了 `minRequestInterval = 1.0s` 的强制限流，防止频繁点击导致的网络拥塞。
*   **请求取消**：在切换槽位、关闭键盘或发起新请求时，立即调用 `cancelCurrentRequest()`，解决网络流量异常及响应延迟问题。
*   **竞态保护**：新增 `isGenerating` 标志位防止重复发起并发请求。

## 4. 其它稳定性修复

*   **编译错误修复**：
    *   修正 `UIActivityIndicatorView.Style.small` 在 iOS 15+ 的兼容性问题。
    *   移除重复定义的 `Array[safe:]` 扩展。
*   **权限检测增强**：优化 `FullAccessChecker`，通过真实的粘贴板读写测试来验证“完全访问”权限的有效性。

## 当前工程状态

*   **槽位系统**：✅ 完美同步（需手动在 Xcode 配置 App Groups 能力）。
*   **交互逻辑**：✅ 已填入、换一条、替换逻辑已跑通。
*   **稳定性**：✅ 网络风暴问题已通过限流和取消机制抑制。

---
*此文件生成于 2026-01-30，由 Antigravity 协助完成。*
